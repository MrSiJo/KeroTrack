{% extends "base.html" %}

{% block title %}KeroTrack - MQTT{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
{% endblock %}

{% block content %}
<div class="container">
    <div class="topics-grid">
        {% for topic, data in topics.items() %}
        <div class="topic-container" id="topic-{{ topic|replace('/', '-') }}">
            <div class="topic-header">
                <div style="display: flex; align-items: center; min-width: 0;">
                    <span class="status-indicator status-inactive" id="status-{{ topic|replace('/', '-') }}"></span>
                    <span class="topic-name">{{ topic }}</span>
                </div>
                <span class="timestamp" id="timestamp-{{ topic|replace('/', '-') }}">
                    {% if data.timestamp %}
                        Last update: {{ data.timestamp }}
                    {% else %}
                        Waiting for messages...
                    {% endif %}
                </span>
            </div>
            <div class="message-container">
                <pre><code class="language-json" id="message-{{ topic|replace('/', '-') }}">{% if data.payload %}{{ data.payload|tojson(indent=2) }}{% else %}Waiting for data...{% endif %}</code></pre>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // Initialize Socket.IO
    const socket = io();

    // Initialize syntax highlighting
    hljs.highlightAll();

    // Handle incoming MQTT messages
    socket.on('mqtt_message', function(data) {
        const topicId = data.topic.replace(/\//g, '-');
        const messageElement = document.getElementById(`message-${topicId}`);
        const timestampElement = document.getElementById(`timestamp-${topicId}`);
        const statusElement = document.getElementById(`status-${topicId}`);

        // Update message content
        messageElement.textContent = JSON.stringify(data.payload, null, 2);
        hljs.highlightElement(messageElement);

        // Update timestamp
        timestampElement.textContent = `Last update: ${data.timestamp}`;

        // Show active status
        statusElement.className = 'status-indicator status-active';
        setTimeout(() => {
            statusElement.className = 'status-indicator status-inactive';
        }, 1000);
    });

    // Handle connection status
    socket.on('connect', function() {
        console.log('Connected to server');
    });

    socket.on('disconnect', function() {
        console.log('Disconnected from server');
    });
</script>
{% endblock %}