{% extends "base.html" %}

{% block title %}KeroTrack - Home{% endblock %}

{% block content %}
<!-- Modern Dashboard Grid -->
<div class="dashboard-grid">
    <!-- Current Status Card -->
    <div class="metric-card">
        <div class="data-freshness fresh">Just updated</div>
        <div class="metric-header">
            <div class="metric-icon">
                <i class="fas fa-tachometer-alt"></i>
            </div>
            <h3 class="metric-title">Current Status</h3>
        </div>
        
        {% if latest_reading %}
        <div class="metric-content">
            <!-- Oil Level Progress -->
            <div class="progress-container mb-3">
                {% set pct = latest_reading.percentage_remaining|float(0) %}
                <div class="progress" role="progressbar" 
                     aria-valuenow="{{ pct }}" aria-valuemin="0" aria-valuemax="100"
                     aria-label="Oil tank level: {{ pct }}% full">
                    <div class="progress-bar {% if pct <= 15 %}progress-low{% elif pct <= 40 %}progress-medium{% else %}progress-good{% endif %}"
                        style="width: {{ pct }}%">
                        <span class="progress-text">{{ "%.1f"|format(pct) }}%</span>
                    </div>
                </div>
            </div>
            
            <!-- Oil Remaining -->
            <div class="metric-item">
                <div class="metric-value" data-realtime="litres_remaining">{{ "%.1f"|format(latest_reading.litres_remaining) }}L</div>
                <div class="metric-label">Oil Remaining</div>
                <div class="metric-trend trend-neutral">
                    <i class="fas fa-minus"></i>
                    <span>Stable</span>
                </div>
            </div>
            
            <!-- Temperature -->
            <div class="metric-item">
                <div class="metric-value" data-realtime="temperature">{{ "%.1f"|format(latest_reading.temperature) }}°C</div>
                <div class="metric-label">Temperature</div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning">No current data available</div>
        {% endif %}
    </div>

    <!-- Usage Forecast Card -->
    <div class="metric-card">
        <div class="data-freshness fresh">Just updated</div>
        <div class="metric-header">
            <div class="metric-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <h3 class="metric-title">Usage Forecast</h3>
        </div>
        
        {% if latest_analysis %}
        <div class="metric-content">
            <!-- Days Remaining -->
            <div class="metric-item">
                {% set days_remaining = latest_analysis.estimated_days_remaining|int(0) %}
                <div class="metric-value" data-realtime="days_remaining">{{ days_remaining }}</div>
                <div class="metric-label">Days Remaining</div>
                <div class="metric-trend {% if days_remaining <= 30 %}trend-down{% elif days_remaining <= 60 %}trend-neutral{% else %}trend-up{% endif %}">
                    <i class="fas fa-{% if days_remaining <= 30 %}exclamation-triangle{% elif days_remaining <= 60 %}minus{% else %}check-circle{% endif %}"></i>
                    <span>{% if days_remaining <= 30 %}Low{% elif days_remaining <= 60 %}Medium{% else %}Good{% endif %}</span>
                </div>
            </div>
            
            <!-- Estimated Empty Date -->
            <div class="metric-item">
                <div class="metric-value" data-realtime="empty_date">{{ latest_analysis.estimated_empty_date.split()[0] }}</div>
                <div class="metric-label">Est. Empty Date</div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning">No analysis data available</div>
        {% endif %}
    </div>

    <!-- Cost Overview Card -->
    <div class="metric-card">
        <div class="data-freshness fresh">Just updated</div>
        <div class="metric-header">
            <div class="metric-icon">
                <i class="fas fa-pound-sign"></i>
            </div>
            <h3 class="metric-title">Cost Overview</h3>
        </div>
        
        {% if latest_reading %}
        <div class="metric-content">
            <!-- Remaining Value -->
            <div class="metric-item">
                <div class="metric-value">£{{ "%.2f"|format(remaining_value) }}</div>
                <div class="metric-label">Remaining Value</div>
            </div>
            
            <!-- Cost to Fill -->
            <div class="metric-item">
                <div class="metric-value">
                    {% if latest_reading.cost_to_fill_float is not none %}
                        £{{ "%.2f"|format(latest_reading.cost_to_fill_float) }}
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="metric-label">Cost to Fill</div>
            </div>
            
            <!-- Litres Needed -->
            <div class="metric-item">
                <div class="metric-value">
                    {% if latest_reading and latest_reading.cost_to_fill_float is not none %}
                        {{ "%.1f"|format(1200 - latest_reading.litres_remaining) }} L
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="metric-label">Litres Needed</div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning">No cost data available</div>
        {% endif %}
    </div>
</div>

<!-- Recent Trend Card -->
<div class="metric-card full-width-card mt-4">
    <div class="metric-header">
        <div class="metric-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <h3 class="metric-title">Recent Trend</h3>
    </div>
    
    {% if mini_graph %}
    <div id="mini-graph" class="mt-3" data-graph="mini_graph" style="height: 300px;"></div>
    {% else %}
    <div class="alert alert-warning mt-3">
        <i class="fas fa-exclamation-triangle me-2"></i>
        No trend data available
    </div>
    {% endif %}
</div>

<!-- Quick Actions Card -->
<div class="metric-card full-width-card">
    <div class="metric-header">
        <div class="metric-icon">
            <i class="fas fa-bolt"></i>
        </div>
        <h3 class="metric-title">Quick Actions</h3>
    </div>
    
    <div class="row mt-3">
        <div class="col-md-3 col-sm-6 mb-3">
            <a href="/historical" class="btn btn-primary w-100" role="button" aria-label="View historical data">
                <i class="fas fa-history me-2"></i>View History
            </a>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <a href="/analysis" class="btn btn-secondary w-100" role="button" aria-label="View detailed analysis">
                <i class="fas fa-calculator me-2"></i>Full Analysis
            </a>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <a href="/settings" class="btn btn-primary w-100" role="button" aria-label="Open settings">
                <i class="fas fa-cog me-2"></i>Settings
            </a>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <button class="btn btn-secondary w-100" onclick="refreshData()" aria-label="Refresh data">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    window.refreshData = function() {
        console.log('Refreshing data...');
        location.reload();
    }

    {% if mini_graph %}
    try {
        const graphDivId = 'mini-graph';
        const graphDiv = document.getElementById(graphDivId);
        const graphData = JSON.parse('{{ mini_graph|safe }}');
        
        console.log("Initializing mini-graph with data");

        function applyTheme(theme) {
            const isDark = theme === 'dark';
            const layoutUpdate = {
                paper_bgcolor: isDark ? 'rgba(20, 30, 48, 0.9)' : '#ffffff',
                plot_bgcolor: isDark ? 'rgba(20, 30, 48, 0.9)' : '#ffffff',
                font: {
                    color: isDark ? '#e0e6ed' : '#212529'
                },
                xaxis: {
                    gridcolor: isDark ? 'rgba(224, 230, 237, 0.1)' : 'rgba(0,0,0,0.1)',
                    zerolinecolor: isDark ? 'rgba(224, 230, 237, 0.1)' : 'rgba(0,0,0,0.1)',
                    linecolor: isDark ? 'rgba(224, 230, 237, 0.1)' : 'rgba(0,0,0,0.1)',
                    tickfont: { color: isDark ? '#e0e6ed' : '#212529' }
                },
                yaxis: {
                    gridcolor: isDark ? 'rgba(224, 230, 237, 0.1)' : 'rgba(0,0,0,0.1)',
                    zerolinecolor: isDark ? 'rgba(224, 230, 237, 0.1)' : 'rgba(0,0,0,0.1)',
                    linecolor: isDark ? 'rgba(224, 230, 237, 0.1)' : 'rgba(0,0,0,0.1)',
                    tickfont: { color: isDark ? '#e0e6ed' : '#212529' }
                }
            };
            
            // Apply theme to graph
            if (graphDiv && graphDiv._fullLayout) {
                Plotly.update(graphDivId, {}, layoutUpdate);
            }
        }

        if (graphDiv) {
            Plotly.newPlot(graphDivId, graphData.data, graphData.layout);
            const initialTheme = document.documentElement.getAttribute('data-theme') || 'light';
            applyTheme(initialTheme);

            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                        const newTheme = document.documentElement.getAttribute('data-theme') || 'light';
                        applyTheme(newTheme);
                    }
                });
            });
            observer.observe(document.documentElement, { attributes: true });
        } else {
            console.error("Element with ID 'mini-graph' not found.");
        }
    } catch (e) {
        console.error('Error initializing mini-graph:', e);
        const graphDiv = document.getElementById('mini-graph');
        if (graphDiv) {
            graphDiv.innerHTML = '<div class="alert alert-danger">Error loading graph: ' + e.message + '</div>';
        }
    }
    {% endif %}
});
</script>
<script src="{{ url_for('static', filename='js/realtime-updates.js') }}"></script>
{% endblock %}